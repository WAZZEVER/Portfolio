<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wazzever Editor (Dual Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase & Toast UI -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/theme/toastui-editor-dark.min.css" />
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <!-- Cursor Effect -->
    <script src="/js/cursor.js" defer></script>

    <style>
        /* Custom Space Theme Overrides */
        .toastui-editor-defaultUI { border: none !important; }
        .toastui-editor-defaultUI .toastui-editor-md-container,
        .toastui-editor-defaultUI .toastui-editor-ww-container { background-color: #0d1117 !important; }
        .toastui-editor-defaultUI-toolbar { background-color: #1f2937 !important; border-bottom: 1px solid #374151 !important; }
        .toastui-editor-contents { font-family: 'Inter', sans-serif !important; font-size: 16px !important; color: #e2e8f0 !important; }
        .toastui-editor-contents p { color: #e2e8f0 !important; }
        .toastui-editor-contents h1, .toastui-editor-contents h2 { color: white !important; border-bottom-color: #374151 !important; }
        .toastui-editor-contents table { border-color: #374151 !important; }
        .toastui-editor-contents th { background-color: #004d48 !important; color: white !important; border-color: #374151 !important; }
        .toastui-editor-contents td { border-color: #374151 !important; }
        .toastui-editor-mode-switch { display: none !important; }
        body { overflow: hidden; }
        
        /* Tab Styling */
        .tab-btn { border-bottom: 2px solid transparent; color: #9ca3af; transition: all 0.3s; }
        .tab-btn.active { border-bottom: 2px solid #3ff3e7; color: #3ff3e7; font-weight: bold; }
    </style>
</head>
<body class="bg-[#050b14] text-white h-screen flex flex-col">

    <!-- Header -->
    <header class="h-16 bg-gray-900 border-b border-gray-800 flex items-center justify-between px-6 shrink-0 z-50">
        <div class="flex items-center gap-4">
            <a href="/admin/dashboard" class="text-gray-400 hover:text-white"><i class="fas fa-arrow-left"></i></a>
            <input type="text" id="title" placeholder="Project Title" class="bg-transparent text-xl font-bold focus:outline-none w-80 text-white placeholder-gray-600">
        </div>
        
        <!-- Phase Selector -->
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 bg-gray-800 px-3 py-1 rounded border border-gray-700">
                <span class="text-xs text-gray-400 uppercase font-bold">Phase:</span>
                <select id="project_phase" class="bg-transparent text-sm text-space-light font-bold outline-none cursor-pointer">
                    <option value="Concept">Concept</option>
                    <option value="Design">Design</option>
                    <option value="Manufacturing">Manufacturing</option>
                    <option value="Building">Building</option>
                    <option value="Refining">Refining</option>
                    <option value="Complete">Complete</option>
                </select>
            </div>

            <div id="upload-status" class="text-xs text-yellow-400 hidden"><i class="fas fa-spinner fa-spin"></i> Uploading...</div>
            
            <select id="status" class="bg-gray-800 text-sm p-2 rounded border border-gray-700 focus:border-teal-500 outline-none">
                <option value="draft">Draft</option>
                <option value="published">Published</option>
            </select>
            
            <button id="save-btn" class="bg-teal-500 hover:bg-teal-400 text-black font-bold py-2 px-6 rounded transition">
                <i class="fas fa-save mr-2"></i> Save
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar -->
        <aside class="w-72 bg-gray-900 border-r border-gray-800 p-6 overflow-y-auto shrink-0 hidden md:block z-40">
            <h3 class="text-gray-400 text-xs uppercase font-bold mb-4">Metadata</h3>
            <div class="space-y-4">
                
                <!-- NEW: THUMBNAIL UPLOADER -->
                <div>
                    <label class="block text-xs text-gray-500 mb-2">Thumbnail Image</label>
                    
                    <!-- Visual Click Area -->
                    <div id="thumb-click-area" class="w-full h-32 bg-gray-800 border-2 border-dashed border-gray-600 rounded-lg flex items-center justify-center cursor-pointer hover:border-space-light hover:bg-gray-700 transition relative overflow-hidden group">
                        
                        <!-- Preview Image (Initially Hidden) -->
                        <img id="thumb-preview" src="" class="absolute inset-0 w-full h-full object-cover hidden">
                        
                        <!-- Placeholder Content -->
                        <div id="thumb-placeholder" class="text-center p-4">
                            <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-1 group-hover:text-space-light"></i>
                            <p class="text-[10px] text-gray-500 group-hover:text-white">Click to Upload</p>
                        </div>

                        <!-- Loading Overlay -->
                        <div id="thumb-loading" class="absolute inset-0 bg-black/50 flex items-center justify-center hidden">
                            <i class="fas fa-spinner fa-spin text-space-light"></i>
                        </div>
                    </div>

                    <!-- Hidden File Input -->
                    <input type="file" id="thumb-file" accept="image/*" class="hidden">
                    <!-- Hidden Text Input to store URL for Save Logic -->
                    <input type="hidden" id="thumbnail">
                </div>

                <div>
                    <label class="block text-xs text-gray-500 mb-1">Short Description</label>
                    <textarea id="description" rows="3" class="w-full bg-gray-800 p-2 rounded text-sm border border-gray-700 focus:border-teal-500 outline-none"></textarea>
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">Tags</label>
                    <input type="text" id="tags" class="w-full bg-gray-800 p-2 rounded text-sm border border-gray-700 focus:border-teal-500 outline-none">
                </div>
                <h3 class="text-gray-400 text-xs uppercase font-bold mt-6 mb-2">Links</h3>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">GitHub URL</label>
                    <input type="text" id="link-github" class="w-full bg-gray-800 p-2 rounded text-sm border border-gray-700 focus:border-teal-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">Demo/Live URL</label>
                    <input type="text" id="link-demo" class="w-full bg-gray-800 p-2 rounded text-sm border border-gray-700 focus:border-teal-500 outline-none">
                </div>
            </div>
        </aside>

        <!-- EDITOR AREA -->
        <div class="flex-1 flex flex-col h-full bg-[#0d1117] min-w-0">
            
            <!-- Editor Tabs -->
            <div class="flex border-b border-gray-800 bg-gray-900/50 px-4">
                <button onclick="switchEditor('main')" id="btn-main" class="tab-btn active px-6 py-3 text-sm font-bold">
                    <i class="fas fa-file-alt mr-2"></i> Main Content
                </button>
                <button onclick="switchEditor('learnings')" id="btn-learnings" class="tab-btn px-6 py-3 text-sm font-bold">
                    <i class="fas fa-brain mr-2"></i> Learnings & Progress
                </button>
            </div>

            <!-- Editor Container 1: Main Content -->
            <div id="editor-main-container" class="flex-1 h-full">
                <div id="editor-main"></div>
            </div>

            <!-- Editor Container 2: Learnings (Hidden by default) -->
            <div id="editor-learnings-container" class="flex-1 h-full hidden">
                <div id="editor-learnings"></div>
            </div>

        </div>
    </div>

    <script type="module">
        import { supabase } from '/js/supabase.js';

        // 1. Auth Check
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) window.location.href = '/admin';

        // --- NEW: THUMBNAIL UPLOAD LOGIC ---
        const thumbClickArea = document.getElementById('thumb-click-area');
        const thumbFileInput = document.getElementById('thumb-file');
        const thumbPreview = document.getElementById('thumb-preview');
        const thumbInputHidden = document.getElementById('thumbnail');
        const thumbLoading = document.getElementById('thumb-loading');
        const thumbPlaceholder = document.getElementById('thumb-placeholder');

        // Trigger file select on click
        thumbClickArea.onclick = () => thumbFileInput.click();

        // Handle File Selection
        thumbFileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Show Loading
            thumbLoading.classList.remove('hidden');

            const fileName = `thumb-${Date.now()}-${Math.floor(Math.random()*1000)}`;
            
            // Upload to Supabase
            const { error } = await supabase.storage.from('project-images').upload(fileName, file);

            if (error) {
                alert('Thumbnail upload failed: ' + error.message);
                thumbLoading.classList.add('hidden');
                return;
            }

            // Get Public URL
            const { data } = supabase.storage.from('project-images').getPublicUrl(fileName);
            const publicUrl = data.publicUrl;

            // Update UI
            thumbPreview.src = publicUrl;
            thumbPreview.classList.remove('hidden');
            thumbPlaceholder.classList.add('hidden');
            
            // Store URL for Save Function
            thumbInputHidden.value = publicUrl;
            
            thumbLoading.classList.add('hidden');
        };


        // 2. Initialize TWO Editors
        const createEditor = (elId) => {
            return new toastui.Editor({
                el: document.querySelector(elId),
                height: '100%',
                initialEditType: 'wysiwyg',
                previewStyle: 'vertical',
                theme: 'dark',
                usageStatistics: false,
                hooks: {
                    addImageBlobHook: async (blob, callback) => {
                        const fileName = `img-${Date.now()}-${Math.floor(Math.random()*1000)}`;
                        const { error } = await supabase.storage.from('project-images').upload(fileName, blob);
                        if (!error) {
                            const { data } = supabase.storage.from('project-images').getPublicUrl(fileName);
                            callback(data.publicUrl, 'image');
                        }
                    }
                }
            });
        };

        const editorMain = createEditor('#editor-main');
        const editorLearnings = createEditor('#editor-learnings');

        // 3. Tab Switching Logic
        window.switchEditor = (tab) => {
            if (tab === 'main') {
                document.getElementById('editor-main-container').classList.remove('hidden');
                document.getElementById('editor-learnings-container').classList.add('hidden');
                document.getElementById('btn-main').classList.add('active');
                document.getElementById('btn-learnings').classList.remove('active');
            } else {
                document.getElementById('editor-main-container').classList.add('hidden');
                document.getElementById('editor-learnings-container').classList.remove('hidden');
                document.getElementById('btn-main').classList.remove('active');
                document.getElementById('btn-learnings').classList.add('active');
                editorLearnings.refresh(); 
            }
        };

        // 4. Load Data
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');

        if (projectId) {
            const { data } = await supabase.from('projects').select('*').eq('id', projectId).single();
            if (data) {
                document.getElementById('title').value = data.title;
                document.getElementById('status').value = data.status;
                document.getElementById('project_phase').value = data.project_phase || 'Concept';
                document.getElementById('description').value = data.description || '';
                document.getElementById('tags').value = (data.tags || []).join(', ');
                
                // Set Thumbnail Data
                if (data.thumbnail_url) {
                    thumbInputHidden.value = data.thumbnail_url;
                    thumbPreview.src = data.thumbnail_url;
                    thumbPreview.classList.remove('hidden');
                    thumbPlaceholder.classList.add('hidden');
                }

                // Set Both Editors
                editorMain.setMarkdown(data.content_md || '');
                editorLearnings.setMarkdown(data.learnings_md || '');

                if (data.links) {
                    document.getElementById('link-github').value = data.links.github || '';
                    document.getElementById('link-demo').value = data.links.demo || '';
                }
            }
        }

        // 5. Save Data
        document.getElementById('save-btn').onclick = async () => {
            const btn = document.getElementById('save-btn');
            btn.innerHTML = 'Saving...';
            btn.disabled = true;

            const payload = {
                title: document.getElementById('title').value,
                status: document.getElementById('status').value,
                project_phase: document.getElementById('project_phase').value,
                thumbnail_url: document.getElementById('thumbnail').value, // Reads from hidden input
                description: document.getElementById('description').value,
                content_md: editorMain.getMarkdown(),
                learnings_md: editorLearnings.getMarkdown(), 
                tags: document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t),
                links: {
                    github: document.getElementById('link-github').value,
                    demo: document.getElementById('link-demo').value
                },
                updated_at: new Date()
            };

            let result;
            if (projectId) {
                result = await supabase.from('projects').update(payload).eq('id', projectId);
            } else {
                result = await supabase.from('projects').insert([payload]);
            }

            if (result.error) alert('Error: ' + result.error.message);
            else window.location.href = '/admin/dashboard';
            
            btn.innerHTML = 'Save';
            btn.disabled = false;
        };
    </script>
</body>
</html>